<!DOCTYPE html>
<html>

<head>
    <title> To-do list </title>
    <link href='https://fonts.googleapis.com/css?family=Indie+Flower' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" type="text/css" href="css/main.css">
</head>

<body>
    <div class="container">
        <div class="display">
            <h1 class="divTitle" onclick="toggleInputDisplay()"> To Do list </h1>
            <div id="toDo"></div>
        </div>
        <div class="input">
            <h3 class="divTitle"> Enter Item </h3>
            <div id="textArea" contenteditable="true" onkeypress="detectEnter(event,this)"></div>
        </div>
    </div>
    <script>
    class ToDo {
        constructor() {
            this._items = []
            this._currItem = null
            this._top = 0
            this._dependencies = []
        }

        get item() {
            return this._items
        }

        set item(val) {

            this._currItem = val

            // Add only items to array
            if (typeof this._currItem === 'string')
                this._items.push(val)

            this._dependencies.forEach(f => {
                f(this)
            })

            this._currItem = null
        }

        addDependency(f) {
            this._dependencies.push(f)
        }
    }

    // New todo list
    var toDoItem = new ToDo()

    // Add item
    toDoItem.addDependency((list) => {

        var parent = document.getElementById('toDo')

        if (list._currItem != null && typeof list._currItem === 'string') {
            var div = document.createElement('div')
                // p.setAttribute('contenteditable', 'true')
            div.setAttribute('class', 'listItems')
            div.setAttribute('id', `item${list._top}`)
            div.setAttribute('onclick', 'itemAction(this)')
            div.textContent = list._items[list._top++]
            parent.insertBefore(div, parent.firstChild)
        }
    })

    // perform action
    toDoItem.addDependency((list) => {
        var parent = document.getElementById('toDo')
        if (list._currItem != null && typeof list._currItem === 'object') {

            // if action is to remove item
            if (list._currItem.action === 'remove') {
                var item = list._currItem.item
                var itemId = item.getAttribute('id')
                var itemIndex = Number(itemId.split(/item/)[1])
                console.log("will remove item: " + item.getAttribute('id'))

                // remove item from DOM
                console.log("Deleting: " + itemId)
                item.remove()

                // remove item from array
                list._items.splice(itemIndex, 1)
                list._top--

                // get all item nodes
                var itemNodes = parent.childNodes

                // Reorder id's of all toDo items
                var index = itemNodes.length - 1
                for(var i = 0; i < itemNodes.length; i++) {
                    // console.log(`Reordering ${itemNodes[i].getAttribute('id')} to item${index}`)
                    itemNodes[i].setAttribute('id', `item${index--}`)                    
                }
            }
        }
    })
    </script>
    <script type="text/javascript" src="js/main.js"></script>
</body>

</html>
